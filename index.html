<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ¬ P2P å½±éŸ³å°è¬›æ©Ÿ (è¢å¹•+èªéŸ³)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: #00ff88; padding: 20px; }
        input { background: #333; border: 1px solid #00ff88; color: white; padding: 10px; border-radius: 5px; width: 100px; font-size: 1.2rem; text-align: center; }
        button { background: #00ff88; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 10px; }
        button:disabled { background: #555; }
        #status { color: #aaa; margin-top: 10px; }
        video { width: 90%; max-width: 900px; border: 2px solid #00ff88; border-radius: 10px; margin-top: 20px; background: #000; box-shadow: 0 0 20px rgba(0,255,136,0.2); }
    </style>
</head>
<body>

    <h2>ğŸ¥ P2P è¢å¹• + èªéŸ³åˆ†äº«</h2>
    
    <div>
        <p>1. è¨­å®šä½ çš„ 4 ä½ ID</p>
        <input type="text" id="myId" maxlength="4" placeholder="8888">
        <button id="regBtn" onclick="initPeer()">å•Ÿå‹•ä¸¦ä¸Šç·š</button>
    </div>

    <hr style="border: 0.5px solid #333; margin: 20px 0;">

    <div>
        <p>2. é€£æ¥å°æ–¹ ID</p>
        <input type="text" id="destId" maxlength="4" placeholder="6666">
        <button id="callBtn" onclick="makeCall()" disabled>æ’¥è™Ÿé€£ç·š</button>
    </div>

    <p id="status">ç‹€æ…‹: ç­‰å¾…ä¸Šç·š...</p>
    
    <video id="remoteVideo" autoplay playsinline controls></video>

    <script>
        let peer, localStream;

        async function initPeer() {
            const id = document.getElementById('myId').value;
            if (id.length < 4) return alert("è«‹è¼¸å…¥ 4 ä½æ•¸ IDï¼");

            try {
                document.getElementById('status').innerText = "æ­£åœ¨å–å¾—è¢å¹•èˆ‡éº¥å…‹é¢¨æ¬Šé™...";
                
                // 1. ç²å–è¢å¹•ç•«é¢
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ 
                    video: true,
                    audio: true // åŒ…å«é›»è…¦ç³»çµ±éŸ³
                });

                // 2. ç²å–éº¥å…‹é¢¨è²éŸ³
                const micStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });

                // 3. æŠŠéº¥å…‹é¢¨çš„éŸ³è»ŒåŠ é€²è¢å¹•ä¸²æµè£¡
                const micTrack = micStream.getAudioTracks()[0];
                screenStream.addTrack(micTrack);
                
                localStream = screenStream;
                
                peer = new Peer(id);

                peer.on('open', (openedId) => {
                    document.getElementById('status').innerText = "ä¸Šç·šæˆåŠŸï¼ID: " + openedId;
                    document.getElementById('regBtn').disabled = true;
                    document.getElementById('callBtn').disabled = false;
                });

                peer.on('call', (call) => {
                    // æ¥è½æ™‚ä¹ŸæŠŠè‡ªå·±çš„è¢å¹•+è²éŸ³å‚³éå»
                    call.answer(localStream); 
                    setupStream(call);
                });

                peer.on('error', (err) => {
                    alert("éŒ¯èª¤: " + err.type);
                });

                // ç•¶åœæ­¢åˆ†äº«è¢å¹•æ™‚è‡ªå‹•é‡æ•´
                localStream.getVideoTracks()[0].onended = () => {
                    location.reload();
                };

            } catch (e) {
                console.error(e);
                alert("å¿…é ˆå…è¨±è¢å¹•åˆ†äº«èˆ‡éº¥å…‹é¢¨æ‰èƒ½æ­£å¸¸é‹ä½œï¼");
            }
        }

        function makeCall() {
            const dest = document.getElementById('destId').value;
            if (!dest) return;
            
            document.getElementById('status').innerText = "æ­£åœ¨é€£ç·š: " + dest;
            const call = peer.call(dest, localStream);
            setupStream(call);
        }

        function setupStream(call) {
            call.on('stream', (remoteStream) => {
                const video = document.getElementById('remoteVideo');
                video.srcObject = remoteStream;
                document.getElementById('status').innerText = "é€šè©±ä¸­ - å½±éŸ³åŒæ­¥å‚³è¼¸ä¸­";
                document.getElementById('status').style.color = "#00ff88";
            });
        }
    </script>
</body>
</html>
