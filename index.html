<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ¥µç°¡ P2P èªéŸ³ ğŸ¤</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: #00ff88; padding: 50px; }
        input { background: #333; border: 1px solid #00ff88; color: white; padding: 10px; border-radius: 5px; width: 100px; font-size: 1.2rem; text-align: center; }
        button { background: #00ff88; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 10px; }
        button:disabled { background: #555; }
        #status { color: #aaa; margin-top: 20px; }
    </style>
</head>
<body>

    <h2>âš¡ P2P èªéŸ³å°è¬›æ©Ÿ</h2>
    
    <div>
        <p>1. è¨­å®šä½ çš„ 4 ä½ ID</p>
        <input type="text" id="myId" maxlength="4" placeholder="8888">
        <button id="regBtn" onclick="initPeer()">ä¸Šç·š</button>
    </div>

    <hr style="border: 0.5px solid #333; margin: 30px 0;">

    <div>
        <p>2. æ’¥æ‰“å°æ–¹ ID</p>
        <input type="text" id="destId" maxlength="4" placeholder="6666">
        <button id="callBtn" onclick="makeCall()" disabled>æ’¥è™Ÿ (Call)</button>
    </div>

    <p id="status">ç‹€æ…‹: ç­‰å¾…ä¸Šç·š...</p>
    
    <audio id="remoteAudio" autoplay></audio>

    <script>
        let peer, localStream;

        // åˆå§‹åŒ–ï¼šç²å–éº¥å…‹é¢¨ä¸¦é€£æ¥ PeerJS å…¬é–‹ä¼ºæœå™¨
        async function initPeer() {
            const id = document.getElementById('myId').value;
            if (id.length < 4) return alert("è«‹è¼¸å…¥ 4 ä½æ•¸ IDï¼");

            try {
                // ç²å–èªéŸ³æµ
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // é€£æ¥å…¬é–‹ä¼ºæœå™¨ (PeerJS é è¨­é›²ç«¯ä¼ºæœå™¨)
                peer = new Peer(id);

                peer.on('open', (openedId) => {
                    document.getElementById('status').innerText = "ä¸Šç·šæˆåŠŸï¼ä½ çš„ ID æ˜¯: " + openedId;
                    document.getElementById('regBtn').disabled = true;
                    document.getElementById('callBtn').disabled = false;
                });

                // ç›£è½åˆ¥äººçš„å‘¼å«
                peer.on('call', (call) => {
                    console.log("æ”¶åˆ°ä¾†é›»...");
                    call.answer(localStream); // æ¥è½ä¸¦å‚³é€è‡ªå·±çš„è²éŸ³
                    setupStream(call);
                });

                peer.on('error', (err) => {
                    alert("éŒ¯èª¤: " + err.type);
                    console.error(err);
                });

            } catch (e) {
                alert("è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™ï¼Œå¦å‰‡ç„¡æ³•é€£ç·šï¼");
            }
        }

        // æ’¥æ‰“é›»è©±
        function makeCall() {
            const dest = document.getElementById('destId').value;
            if (!dest) return;
            
            document.getElementById('status').innerText = "æ­£åœ¨å‘¼å«: " + dest;
            const call = peer.call(dest, localStream);
            setupStream(call);
        }

        // è™•ç†èªéŸ³ä¸²æµ
        function setupStream(call) {
            call.on('stream', (remoteStream) => {
                const audio = document.getElementById('remoteAudio');
                audio.srcObject = remoteStream;
                document.getElementById('status').innerText = "é€šè©±ä¸­ - æ­£åœ¨é€£ç·šå°æ–¹...";
                document.getElementById('status').style.color = "#00ff88";
            });
        }
    </script>
</body>
</html>
